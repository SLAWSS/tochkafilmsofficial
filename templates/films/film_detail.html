{% extends 'films/base.html' %}

{% block title %}{{ film.title }} - TochkaFilms{% endblock %}

{% block content %}
<div class="film-detail">
    <div class="container">
        <div class="film-header">
            <div class="film-poster">
                {% if film.poster %}
                    <img src="{{ film.poster.url }}" alt="{{ film.title }}">
                {% endif %}
            </div>
            <div class="film-meta">
                <h1>{{ film.title }}</h1>
                <p class="film-stats">
                    {{ film.year }} | {{ film.duration }} –º–∏–Ω | 
                    {% if avg_rating %}‚≠ê {{ avg_rating|floatformat:1 }}{% else %}‚≠ê {{ film.rating }}{% endif %}
                </p>
                <div class="categories">
                    {% for category in film.categories.all %}
                        <span class="category-tag">{{ category.name }}</span>
                    {% endfor %}
                </div>
                <p class="description">{{ film.description }}</p>
                
                <!-- –ê–∫—Ç–µ—Ä—ã -->
                {% if film.actors.all %}
                <div class="actors-section">
                    <h3>–í —Ä–æ–ª—è—Ö:</h3>
                    <div class="actors-list">
                        {% for actor in film.actors.all %}
                        <a href="{% url 'films:actor_detail' actor.pk %}" class="actor-card">
                            <div class="actor-photo">
                                {% if actor.photo %}
                                    <img src="{{ actor.photo.url }}" alt="{{ actor.name }}">
                                {% else %}
                                    <div class="no-photo">üë§</div>
                                {% endif %}
                            </div>
                            <div class="actor-name">{{ actor.name }}</div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if user.is_authenticated %}
                <div class="actions">
                    <a href="{% url 'films:toggle_favorite' film.pk %}" class="btn">
                        {% if is_favorite %}‚ù§Ô∏è –£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %}ü§ç –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}
                    </a>
                    <a href="{% url 'films:toggle_watchlist' film.pk %}" class="btn">
                        {% if is_in_watchlist %}‚úì –í —Å–ø–∏—Å–∫–µ{% else %}+ –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫{% endif %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {% if film.trailer_url %}
        <div class="trailer-section {% if 'kinoafisha.info' in film.trailer_url %}kinoafisha-trailer{% elif 'kino-teatr.ru' in film.trailer_url %}kinoteatr-trailer{% elif 'film.ru' in film.trailer_url %}filmru-trailer{% elif 'kinokrad.co' in film.trailer_url %}kinokrad-trailer{% elif 'hdrezka.ag' in film.trailer_url %}hdrezka-trailer{% elif 'kinopoisk.ru' in film.trailer_url %}kinopoisk-trailer{% elif 'okko.tv' in film.trailer_url %}okko-trailer{% elif 'wink.ru' in film.trailer_url %}wink-trailer{% elif 'start.ru' in film.trailer_url %}start-trailer{% elif 'ivi.ru' in film.trailer_url %}ivi-trailer{% elif 'vk.com' in film.trailer_url %}vk-trailer{% elif 'rutube.ru' in film.trailer_url %}rutube-trailer{% endif %}" id="trailer">
            <h2 class="gradient-text-red">üá∑üá∫ –¢—Ä–µ–π–ª–µ—Ä –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</h2>
            
            <div class="trailer-container">
                {% if 'rutube.ru' in film.trailer_url %}
                    <!-- –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π Rutube –ø–ª–µ–µ—Ä -->
                    <div class="trailer-wrapper" id="trailer-wrapper">
                        <iframe 
                            data-src="{{ film.trailer_url }}" 
                            title="–¢—Ä–µ–π–ª–µ—Ä {{ film.title }} –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
                            frameborder="0" 
                            allowfullscreen
                            loading="lazy"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            referrerpolicy="strict-origin-when-cross-origin">
                        </iframe>
                        <div class="trailer-overlay" onclick="playTrailer()">
                            <div class="play-button">‚ñ∂</div>
                            <div class="play-text">–°–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–µ–π–ª–µ—Ä</div>
                        </div>
                    </div>
                {% else %}
                    <!-- –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –∫–∏–Ω–æ-—Å–∞–π—Ç -->
                    <div class="trailer-alternative">
                        <div class="alternative-content">
                            <h3>üé¨ –°–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–µ–π–ª–µ—Ä –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</h3>
                            <p>–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é —Ä–æ—Å—Å–∏–π—Å–∫—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É:</p>
                            <a href="{{ film.trailer_url }}" target="_blank" class="btn btn-primary">
                            {% if 'kinoafisha.info' in film.trailer_url %}
                                üé≠ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ö–∏–Ω–æ–ê—Ñ–∏—à–µ
                            {% elif 'kino-teatr.ru' in film.trailer_url %}
                                üé™ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ö–∏–Ω–æ-–¢–µ–∞—Ç—Ä.—Ä—É
                            {% elif 'film.ru' in film.trailer_url %}
                                üé¨ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ Film.ru
                            {% elif 'kinokrad.co' in film.trailer_url %}
                                üéØ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ö–∏–Ω–æ–∫—Ä–∞–¥
                            {% elif 'hdrezka.ag' in film.trailer_url %}
                                üì∫ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ HDRezka
                            {% elif 'kinopoisk.ru' in film.trailer_url %}
                                üü° –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ö–∏–Ω–æ–ü–æ–∏—Å–∫ HD
                            {% elif 'okko.tv' in film.trailer_url %}
                                üü¢ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ Okko
                            {% elif 'wink.ru' in film.trailer_url %}
                                üü£ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ Wink
                            {% elif 'start.ru' in film.trailer_url %}
                                üü£ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ START
                            {% elif 'ivi.ru' in film.trailer_url %}
                                üî¥ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ ivi
                            {% elif 'vk.com' in film.trailer_url %}
                                üì∫ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ VK Video
                            {% elif 'rutube.ru' in film.trailer_url %}
                                üì∫ –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ Rutube
                            {% else %}
                                üì∫ –°–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–µ–π–ª–µ—Ä
                            {% endif %}
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="trailer-info">
                <div class="platform-badge">
                    {% if 'kinoafisha.info' in film.trailer_url %}
                        <span class="kinoafisha-badge">üé≠ –ö–∏–Ω–æ–ê—Ñ–∏—à–∞</span>
                    {% elif 'kino-teatr.ru' in film.trailer_url %}
                        <span class="kinoteatr-badge">üé™ –ö–∏–Ω–æ-–¢–µ–∞—Ç—Ä.—Ä—É</span>
                    {% elif 'film.ru' in film.trailer_url %}
                        <span class="filmru-badge">üé¨ Film.ru</span>
                    {% elif 'kinokrad.co' in film.trailer_url %}
                        <span class="kinokrad-badge">üéØ –ö–∏–Ω–æ–∫—Ä–∞–¥</span>
                    {% elif 'hdrezka.ag' in film.trailer_url %}
                        <span class="hdrezka-badge">üì∫ HDRezka</span>
                    {% elif 'kinopoisk.ru' in film.trailer_url %}
                        <span class="kinopoisk-badge">üü° –ö–∏–Ω–æ–ü–æ–∏—Å–∫ HD</span>
                    {% elif 'okko.tv' in film.trailer_url %}
                        <span class="okko-badge">üü¢ Okko</span>
                    {% elif 'wink.ru' in film.trailer_url %}
                        <span class="wink-badge">üü£ Wink</span>
                    {% elif 'start.ru' in film.trailer_url %}
                        <span class="start-badge">üü£ START</span>
                    {% elif 'ivi.ru' in film.trailer_url %}
                        <span class="ivi-badge">üî¥ ivi</span>
                    {% elif 'vk.com' in film.trailer_url %}
                        <span class="vk-badge">üì∫ VK Video</span>
                    {% elif 'rutube.ru' in film.trailer_url %}
                        <span class="rutube-badge">üì∫ Rutube</span>
                    {% else %}
                        <span class="video-badge">üì∫ –í–∏–¥–µ–æ</span>
                    {% endif %}
                    <span class="russian-flag">üá∑üá∫ –†—É—Å—Å–∫–∞—è –æ–∑–≤—É—á–∫–∞</span>
                </div>
                <p class="trailer-description">
                    –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–ª–µ—Ä —Ñ–∏–ª—å–º–∞ "{{ film.title }}" —Å —Ä—É—Å—Å–∫–æ–π –æ–∑–≤—É—á–∫–æ–π. 
                    –ö–∞—á–µ—Å—Ç–≤–æ HD, –±–µ–∑ —Ä–µ–∫–ª–∞–º—ã.
                </p>
            </div>
        </div>
        {% endif %}

        <div class="reviews-section">
            <h2>–û—Ç–∑—ã–≤—ã</h2>
            
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'films:add_review' film.pk %}" class="review-form">
                {% csrf_token %}
                <label>–û—Ü–µ–Ω–∫–∞:</label>
                <select name="rating" required>
                    {% for i in "12345678910" %}
                        <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                    {% endfor %}
                </select>
                <textarea name="comment" placeholder="–í–∞—à –æ—Ç–∑—ã–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
            </form>
            {% endif %}

            <div class="reviews-list">
                {% for review in reviews %}
                <div class="review">
                    <div class="review-header">
                        <strong>{{ review.user.username }}</strong>
                        <span class="rating">‚≠ê {{ review.rating }}/10</span>
                    </div>
                    {% if review.comment %}
                        <p>{{ review.comment }}</p>
                    {% endif %}
                    <small>{{ review.created_at|date:"d.m.Y H:i" }}</small>
                </div>
                {% empty %}
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                {% endfor %}
            </div>
        </div>

        {% if similar_films %}
        <div class="similar-films">
            <h2>üé¨ –ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã</h2>
            <div class="film-grid">
                {% for film in similar_films %}
                <div class="film-card">
                    {% if film.trailer_url %}
                        {% if 'kinoafisha.info' in film.trailer_url %}
                            <div class="russian-badge kinoafisha-badge">–ö–∏–Ω–æ–ê—Ñ–∏—à–∞</div>
                        {% elif 'kino-teatr.ru' in film.trailer_url %}
                            <div class="russian-badge kinoteatr-badge">–ö–∏–Ω–æ-–¢–µ–∞—Ç—Ä</div>
                        {% elif 'film.ru' in film.trailer_url %}
                            <div class="russian-badge filmru-badge">Film.ru</div>
                        {% elif 'kinokrad.co' in film.trailer_url %}
                            <div class="russian-badge kinokrad-badge">–ö–∏–Ω–æ–∫—Ä–∞–¥</div>
                        {% elif 'hdrezka.ag' in film.trailer_url %}
                            <div class="russian-badge hdrezka-badge">HDRezka</div>
                        {% elif 'vk.com' in film.trailer_url %}
                            <div class="russian-badge vk-badge">VK</div>
                        {% elif 'rutube.ru' in film.trailer_url %}
                            <div class="russian-badge rutube-badge">RuTube</div>
                        {% endif %}
                    {% endif %}
                    <a href="{% url 'films:film_detail' film.pk %}">
                        {% if film.poster %}
                            <img src="{{ film.poster.url }}" alt="{{ film.title }}">
                            {% if film.trailer_url %}
                                <div class="play-overlay"></div>
                            {% endif %}
                        {% else %}
                            <div class="no-poster">{{ film.title }}</div>
                        {% endif %}
                        <div class="film-info">
                            <h3>{{ film.title }}</h3>
                            <p>{{ film.year }} | <span class="rating-stars">‚≠ê {{ film.rating }}</span></p>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function convertRutubeUrl(url) {
    if (!url || !url.includes('rutube.ru')) {
        return url;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≤–∏–¥–µ–æ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ Rutube URL
    const patterns = [
        /rutube\.ru\/video\/([a-f0-9]+)\/?/,  // https://rutube.ru/video/abc123/
        /rutube\.ru\/play\/embed\/([a-f0-9]+)\/?/,  // https://rutube.ru/play/embed/abc123/
        /rutube\.ru\/embed\/([a-f0-9]+)\/?/,  // https://rutube.ru/embed/abc123/
        /player\.rutube\.ru\/embed\/([a-f0-9]+)\/?/  // https://player.rutube.ru/embed/abc123/
    ];
    
    let videoId = null;
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
            videoId = match[1];
            break;
        }
    }
    
    if (videoId) {
        // –°–æ–∑–¥–∞–µ–º embed URL
        return `https://rutube.ru/play/embed/${videoId}/?skinColor=e50914&autoStart=false&bmstart=false`;
    }
    
    return url;
}

function playTrailer() {
    const overlay = document.querySelector('.trailer-overlay');
    const iframe = document.querySelector('.trailer-wrapper iframe');
    
    if (overlay && iframe) {
        overlay.style.display = 'none';
        
        // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ
        const originalUrl = iframe.getAttribute('data-src');
        const embedUrl = convertRutubeUrl(originalUrl);
        
        // –î–æ–±–∞–≤–ª—è–µ–º autoplay
        let finalUrl = embedUrl;
        if (finalUrl.includes('rutube.ru')) {
            finalUrl += (finalUrl.includes('?') ? '&' : '?') + 'autoStart=true';
        }
        
        iframe.src = finalUrl;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const iframe = document.querySelector('.trailer-wrapper iframe');
    if (iframe) {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const originalUrl = iframe.getAttribute('data-src');
        const embedUrl = convertRutubeUrl(originalUrl);
        iframe.src = embedUrl;
        
        iframe.addEventListener('load', function() {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            setTimeout(() => {
                const overlay = document.querySelector('.trailer-overlay');
                if (overlay) {
                    overlay.style.opacity = '0.8';
                }
            }, 1000);
        });
    }
});
</script>

{% endblock %}