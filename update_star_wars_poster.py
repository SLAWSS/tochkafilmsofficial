import requests
from django.core.management.base import BaseCommand
from django.core.files.base import ContentFile
from films.models import Film


class Command(BaseCommand):
    help = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–µ—Ä–∞ –¥–ª—è —Ñ–∏–ª—å–º–∞ "–ó–≤–µ–∑–¥–Ω—ã–µ –≤–æ–π–Ω—ã: –ù–æ–≤–∞—è –Ω–∞–¥–µ–∂–¥–∞"'

    def handle(self, *args, **options):
        self.stdout.write("üåü –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–°–¢–ï–†–ê –ó–í–ï–ó–î–ù–´–• –í–û–ô–ù")
        self.stdout.write("=" * 50)
        
        # –ù–æ–≤—ã–π URL –ø–æ—Å—Ç–µ—Ä–∞
        poster_url = 'https://ir.ozone.ru/s3/multimedia-y/c1000/6174008410.jpg'
        
        try:
            # –ò—â–µ–º —Ñ–∏–ª—å–º
            film = Film.objects.get(title='–ó–≤–µ–∑–¥–Ω—ã–µ –≤–æ–π–Ω—ã: –ù–æ–≤–∞—è –Ω–∞–¥–µ–∂–¥–∞')
            self.stdout.write(f"üìΩÔ∏è –ù–∞–π–¥–µ–Ω —Ñ–∏–ª—å–º: {film.title}")
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Å—Ç–µ—Ä
            self.stdout.write("üì• –ó–∞–≥—Ä—É–∂–∞—é –Ω–æ–≤—ã–π –ø–æ—Å—Ç–µ—Ä...")
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                'Accept': 'image/webp,image/apng,image/*,*/*;q=0.8',
                'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8',
                'Accept-Encoding': 'gzip, deflate, br',
                'DNT': '1',
                'Connection': 'keep-alive',
                'Referer': 'https://www.ozone.ru/',
            }
            
            response = requests.get(poster_url, timeout=30, headers=headers)
            response.raise_for_status()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            if len(response.content) < 1000:
                raise Exception("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            content_type = response.headers.get('content-type', '')
            if not content_type.startswith('image/'):
                self.stdout.write(f"‚ö†Ô∏è Content-Type: {content_type}")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å—Ç–µ—Ä
            filename = "star_wars_new_hope_ozone.jpg"
            film.poster.save(filename, ContentFile(response.content), save=True)
            
            self.stdout.write(self.style.SUCCESS("‚úÖ –ü–û–°–¢–ï–† –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù!"))
            self.stdout.write(f"üìÅ –§–∞–π–ª: {filename}")
            self.stdout.write(f"üìè –†–∞–∑–º–µ—Ä: {len(response.content)} –±–∞–π—Ç")
            self.stdout.write(f"üîó URL: {film.poster.url}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            film.refresh_from_db()
            if film.poster:
                self.stdout.write(self.style.SUCCESS("üåü –ü–æ—Å—Ç–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"))
                self.stdout.write(f"üìÇ –ü—É—Ç—å: {film.poster.name}")
            else:
                self.stdout.write(self.style.ERROR("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ"))
                
        except Film.DoesNotExist:
            self.stdout.write(self.style.ERROR('‚ùå –§–∏–ª—å–º "–ó–≤–µ–∑–¥–Ω—ã–µ –≤–æ–π–Ω—ã: –ù–æ–≤–∞—è –Ω–∞–¥–µ–∂–¥–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω'))
            self.stdout.write("üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–ª—å–º—ã —Å–æ '–ó–≤–µ–∑–¥–Ω—ã–µ':")
            for film in Film.objects.filter(title__icontains='–ó–≤–µ–∑–¥–Ω—ã–µ'):
                self.stdout.write(f"  - {film.title}")
                
        except requests.exceptions.RequestException as e:
            self.stdout.write(self.style.ERROR(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {str(e)}"))
            
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: {str(e)}"))
        
        self.stdout.write("\nüöÄ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")